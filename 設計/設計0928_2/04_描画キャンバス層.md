# 04_描画キャンバス層

描画キャンバス集約とUIコンポーネントとの連携、コマンドパターンによる処理実行を定義します。実際のコード構造に基づいてオブザーバーパターンやイベント処理を含めています。

```mermaid
classDiagram
    direction RL
    %% ========== UIコンポーネント基盤 ==========
    class UIComponentBase {
        <<抽象クラス>>
        #_dom: DomProxy
        +constructor()
        +delete(): void
        +setStyleCSS(style: Partial~CSSStyleDeclaration~): this
        +bind(func: (component: this) => void): this
        +addClass(className: string | string[]): this
        +show(): this
        +hide(): this
    }
    
    class LV1UIComponentBase {
        <<抽象クラス>>
        +addTypedEventListener~T~(event: T, listener: TypedEventListener~T~): this
        +onClick(callback: TypedEventListener~'click'~): this
        +onMouseMove(callback: TypedEventListener~'mousemove'~): this
        +onMouseDown(callback: TypedEventListener~'mousedown'~): this
    }
    
    class LV2UIComponentBase {
        <<抽象クラス>>
        #_componentRoot: UIComponentBase
        #createComponentRoot(): UIComponentBase
        +constructor()
    }
    
    class DivC {
        +constructor(options?: DivOptions)
        +childs(children: Iterable~UIComponentBase~): this
        +addDivEventListener~T~(event: T, listener: TypedEventListener~T~): this
    }
    
    class CanvasC {
        +constructor(options?: CanvasOptions)
        +setWidth(width: number): this
        +setHeight(height: number): this
        +getContext2D(): CanvasRenderingContext2D | null
        +onMouseMove(callback: TypedEventListener~'mousemove'~): this
        +onMouseDown(callback: TypedEventListener~'mousedown'~): this
        +onMouseUp(callback: TypedEventListener~'mouseup'~): this
    }
    
    class SvgC {
        +constructor(options?: SvgOptions)
        +setWidth(width: number): this
        +setHeight(height: number): this
        +setViewBox(viewBox: string): this
        +addSvgEventListener~T~(event: T, listener: TypedEventListener~T~): this
    }
    
    %% ========== 描画キャンバス実装クラス群 ==========
    class I描画キャンバスVM {
        <<interface>>
    }
    
    class I描画キャンバスView {
        <<interface>>
    }
    
    class 描画キャンバスVM {
        +グラフVM標準描画座標: グラフVM標準描画座標
        -_ノードVM標準: ノードVM標準画面座標
        +constructor(グラフVM標準描画座標: グラフVM標準描画座標, ノードVM標準: ノードVM標準画面座標)
        +ノードVM標準(): ノードVM標準画面座標
        +作成コマンド実行~T_View~(コマンド: コマンド~描画キャンバスVM, T_View~): T_View
        +状態変更コマンド実行(コマンド: コマンド~描画キャンバスVM, void~): void
    }
    
    class 描画キャンバスView {
        #_componentRoot: DivC
        +constructor()
        #createComponentRoot(): DivC
        +キャンバス要素追加(要素: UIComponentBase): void
        +キャンバス要素削除(要素: UIComponentBase): void
        +イベントリスナー登録(イベント種別: string, ハンドラー: Function): void
    }
    
    class 描画キャンバス集約 {
        -_view: I描画キャンバスView
        -_vm: I描画キャンバスVM
        +constructor()
        +配置物追加(配置物集約: I配置物集約): void
        +配置物削除(配置物ID: 配置物ID): void
        +マウスイベント処理開始(): void
        +描画更新実行(): void
    }
    
    %% ========== コマンドパターン実装 ==========
    class コマンドT_VM_T_View {
        <<interface>>
        +実行(VM: T_VM): T_View
    }
    
    class 付箋作成コマンド {
        -位置: 描画座標点
        -サイズ: サイズ
        +constructor(位置: 描画座標点, サイズ: サイズ)
        +実行(描画キャンバスVM: 描画キャンバスVM): 付箋集約
    }
    
    class 矢印作成コマンド {
        -開始点: 描画座標点
        -終了点: 描画座標点
        -矢印種別: '直線' | '曲線' | '折れ線'
        +constructor(開始点: 描画座標点, 終了点: 描画座標点, 種別: string)
        +実行(描画キャンバスVM: 描画キャンバスVM): I配置物集約
    }
    
    class 配置物移動コマンド {
        -配置物ID: 配置物ID
        -新しい位置: 描画座標点
        +constructor(配置物ID: 配置物ID, 新しい位置: 描画座標点)
        +実行(描画キャンバスVM: 描画キャンバスVM): void
    }
    
    %% ========== イベントハンドリング ==========
    class マウスイベントハンドラー {
        -描画キャンバス集約: 描画キャンバス集約
        -ドラッグ中フラグ: boolean
        -ドラッグ開始位置: 描画座標点
        +constructor(描画キャンバス集約: 描画キャンバス集約)
        +マウス押下処理(イベント: MouseEvent): void
        +マウス移動処理(イベント: MouseEvent): void
        +マウス離上処理(イベント: MouseEvent): void
        +クリック処理(イベント: MouseEvent): void
    }
    
    class キーボードイベントハンドラー {
        -描画キャンバス集約: 描画キャンバス集約
        +constructor(描画キャンバス集約: 描画キャンバス集約)
        +キー押下処理(イベント: KeyboardEvent): void
        +削除キー処理(): void
        +コピーペースト処理(操作種別: 'copy' | 'paste'): void
    }
    
    %% ========== 座標変換ユーティリティ ==========
    class 座標変換ユーティリティ {
        <<namespace>>
        +マウス位置を描画座標に変換(マウスイベント: MouseEvent, キャンバス要素: HTMLElement): 描画座標点
        +画面座標を描画座標に変換(画面座標: 画面座標点, 描画基準: 描画基準座標): 描画座標点
        +描画座標を画面座標に変換(描画座標: 描画座標点): 画面座標点
    }
    
    %% ========== 関係性 ==========
    LV1UIComponentBase --|> UIComponentBase : 継承
    LV2UIComponentBase --|> UIComponentBase : 継承
    DivC --|> LV1UIComponentBase : 継承
    CanvasC --|> LV1UIComponentBase : 継承
    SvgC --|> LV1UIComponentBase : 継承
    
    描画キャンバスVM ..|> I描画キャンバスVM : 実装
    描画キャンバスVM ..|> IグラフVM標準描画座標を持つ : 実装
    描画キャンバスVM ..|> IノードVM標準画面座標と見なせる : 実装
    
    描画キャンバスView ..|> I描画キャンバスView : 実装
    描画キャンバスView --|> LV2UIComponentBase : 継承
    
    付箋作成コマンド ..|> コマンドT_VM_T_View : 実装
    矢印作成コマンド ..|> コマンドT_VM_T_View : 実装
    配置物移動コマンド ..|> コマンドT_VM_T_View : 実装
    
    %% 集約関係
    描画キャンバス集約 "1" --> "1" I描画キャンバスView : _view
    描画キャンバス集約 "1" --> "1" I描画キャンバスVM : _vm
    
    描画キャンバス集約 "1" --> "1" マウスイベントハンドラー : 使用
    描画キャンバス集約 "1" --> "1" キーボードイベントハンドラー : 使用
    
    マウスイベントハンドラー --> 座標変換ユーティリティ : 使用
    キーボードイベントハンドラー --> 座標変換ユーティリティ : 使用
    
    描画キャンバスVM "1" --> "*" I配置物集約 : グラフ内で管理
    描画キャンバスView "1" --> "*" UIComponentBase : 子要素として配置
    
    %% コマンドパターンの使用関係
    描画キャンバス集約 --> 付箋作成コマンド : 実行
    描画キャンバス集約 --> 矢印作成コマンド : 実行
    描画キャンバス集約 --> 配置物移動コマンド : 実行
```

## 説明

### UIコンポーネント基盤
- **UIComponentBase**: すべてのUIコンポーネントの基本クラス
- **LV1UIComponentBase**: HTML要素に直接対応するコンポーネント
- **LV2UIComponentBase**: LV1を組み合わせて作る複合コンポーネント
- 型安全なイベントリスナー登録をサポート

### 描画キャンバス実装
- **集約パターン**: ViewとVMを分離し、集約クラスで結合
- **グラフVM管理**: 描画座標系でのノード・エッジ情報を保持
- **画面座標系対応**: キャンバス自体は画面座標系のノードとして振る舞う

### コマンドパターン実装
- **作成コマンド**: 新しい配置物の作成処理
- **変更コマンド**: 既存配置物の移動・削除処理
- **Undo/Redo対応**: 将来的なコマンド履歴管理を想定

### イベントハンドリング
- **マウスイベント**: ドラッグ&ドロップ、クリック選択
- **キーボードイベント**: 削除、コピー&ペースト
- **座標変換**: マウス座標から描画座標への変換処理

### 実際のコード構造との対応
- `CanvasC`の`onMouseMove()`、`onMouseDown()`等のメソッドを使用
- `描画キャンバスVM`は`IグラフVM標準描画座標を持つ`と`IノードVM標準画面座標と見なせる`を実装
- コマンドインターフェースは`実行(VM: T_VM): T_View`の形式

---
[← README に戻る](./README.md)